<head>
  <style>
    body { margin: 0; }
    #info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      display: none;
    }
  </style>

  <script src="//unpkg.com/3d-force-graph"></script>
  <script src="https://unpkg.com/neo4j-driver"></script>
</head>

<body>
  <div id="3d-graph"></div>
  <div id="info-panel"></div>

  <script>
    const driver = neo4j.driver("neo4j+s://7714be1a.databases.neo4j.io", neo4j.auth.basic("neo4j", "lwW-hWpruNTNNrD-gCAMreXMZcUlAFcrjxmaeL94ZzM"));
    const session = driver.session({ database: "neo4j" });
    const start = new Date();

    session
      .run(
        'MATCH (u:User)-[r:CONNECTED_TO]->(v:User) RETURN u.name AS source, v.name AS target, v.role AS role, v.title AS title, v.website AS website LIMIT $limit', 
        { limit: neo4j.int(5000) }
      )
      .then(function (result) {
        const links = result.records.map(r => ({ 
          source: r.get('source'), 
          target: r.get('target')  
        }));

        const nodesMap = new Map();

        result.records.forEach(r => {
          const addNode = (id, role, title, website) => {
            if (!nodesMap.has(id)) {
              nodesMap.set(id, { id, name: id, role, title, website });
            }
          };

          addNode(r.get('source'), null, null, null);
          addNode(r.get('target'), r.get('role'), r.get('title'), r.get('website'));
        });

        const nodes = Array.from(nodesMap.values());

        const gData = { nodes, links };

        const Graph = ForceGraph3D()(document.getElementById('3d-graph'))
          .graphData(gData)
          .nodeLabel('role')
          .onNodeClick(node => {
            const infoPanel = document.getElementById('info-panel');
            infoPanel.innerHTML = `
              <h3>Network Info</h3>
              <p><strong>Name:</strong> ${node.name}</p>
              <p><strong>Title:</strong> ${node.title || 'N/A'}</p>
              <p><strong>Role:</strong> ${node.role || 'N/A'}</p>
              <p><strong>Website:</strong> ${node.website && node.website !== '' ? `<a href="${node.website}" target="_blank" rel="noopener noreferrer">${node.website.length > 30 ? `${node.website.substring(0, 30)}...` : node.website}</a>` : ''}</p>
              <button onclick="document.getElementById('info-panel').style.display='none'">Close</button>
            `;
            infoPanel.style.display = 'block';
          });

        session.close();
      })
      .catch(error => console.error("Error running query:", error));
  </script>
</body>
